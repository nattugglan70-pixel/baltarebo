<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Dashboard Väder & Elpris</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f4f4;
    color: #222;
    margin: 20px;
  }
  h1, h2 {
    margin: 10px 0;
  }
  .section {
    margin-bottom: 25px;
    padding: 10px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  .weather-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
  }
  .weather-item {
    background: #e9f0f7;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
  }
  .elpris {
    display: flex;
    justify-content: space-around;
    padding: 10px;
    background: #fff4e6;
    border-radius: 6px;
  }
  .elpris div {
    text-align: center;
  }
  .small-text {
    font-size: 0.8em;
    color: #555;
  }
</style>
</head>
<body>

<div class="section">
  <h1 id="datum">Datum: --</h1>
  <h2 id="veckonummer">Vecka: --</h2>
</div>

<div class="section">
  <h2>Väder</h2>
  <div class="weather-grid" id="weatherGrid">
    <!-- Väderdata fylls på här -->
  </div>
  <p class="small-text" id="weatherUpdated">Senast uppdaterad: --:--</p>
</div>

<div class="section">
  <h2>Elpris (SEK/kWh)</h2>
  <div class="elpris">
    <div>
      <h3 id="elprisTidigare">Tidigare: --</h3>
      <p class="small-text" id="elprisTidigareTid">Tid: --:--</p>
    </div>
    <div>
      <h3 id="elprisNu">Nu: --</h3>
      <p class="small-text" id="elprisNuTid">Uppdaterad: --:--</p>
    </div>
  </div>
</div>

<script>
const lat = 57.114025;
const lon = 14.168177;

// Datum och veckonummer
function uppdateraDatum() {
  const nu = new Date();
  const vecka = getWeekNumber(nu);
  document.getElementById("datum").textContent = `Datum: ${nu.toISOString().split('T')[0]}`;
  document.getElementById("veckonummer").textContent = `Vecka: ${vecka}`;
}
function getWeekNumber(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
}

// Väder (temperatur.nu via GitHub)
async function fetchWeather() {
  try {
    const response = await fetch(`https://temperatur.nu/api/forecast?lat=${lat}&lon=${lon}`);
    const data = await response.json();
    const weatherGrid = document.getElementById("weatherGrid");
    weatherGrid.innerHTML = "";

    // Hämta första timmen (eller mer om du vill)
    const now = new Date();
    const firstHour = data.hours[0]; // justera om API har annan struktur
    const items = [
      {label: "Temperatur", value: firstHour.temp + " °C"},
      {label: "Känns som", value: firstHour.feelsLike + " °C"},
      {label: "Vind", value: firstHour.windSpeed + " m/s"},
      {label: "Vindriktning", value: firstHour.windDir}
    ];

    items.forEach(i => {
      const div = document.createElement("div");
      div.className = "weather-item";
      div.innerHTML = `<strong>${i.label}</strong><br>${i.value}`;
      weatherGrid.appendChild(div);
    });

    document.getElementById("weatherUpdated").textContent = 
      `Senast väderuppdatering: ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
  } catch(e) {
    console.error("Fel vid hämtning av väder:", e);
  }
}

// Elpris (elprisetjustnu.se) – zon 4, södra Sverige
let elprisTidigare = null;
async function fetchElpris() {
  try {
    const response = await fetch("https://elprisetjustnu.se/api/v1/zone/4.json");
    const data = await response.json();

    // Hämta aktuell timme
    const nu = new Date();
    const currentHour = nu.getHours();

    // Sortera och hitta senaste priset
    const priser = data.filter(p => new Date(p.time_start).getHours() <= currentHour);
    const senaste = priser[priser.length-1];
    const tidigare = priser[priser.length-2];

    if(tidigare) {
      document.getElementById("elprisTidigare").textContent = `Tidigare: ${tidigare.SEK_per_kWh.toFixed(2)}`;
      document.getElementById("elprisTidigareTid").textContent = `Tid: ${new Date(tidigare.time_start).getHours()}:00`;
    } else {
      document.getElementById("elprisTidigare").textContent = `Tidigare: --`;
      document.getElementById("elprisTidigareTid").textContent = `Tid: --`;
    }

    if(senaste) {
      document.getElementById("elprisNu").textContent = `Nu: ${senaste.SEK_per_kWh.toFixed(2)}`;
      document.getElementById("elprisNuTid").textContent = `Uppdaterad: ${new Date(senaste.time_start).getHours()}:00`;
    } else {
      document.getElementById("elprisNu").textContent = `Nu: --`;
      document.getElementById("elprisNuTid").textContent = `Uppdaterad: --:--`;
    }

  } catch(e) {
    console.error("Fel vid hämtning av elpris:", e);
  }
}

// Init & interval
uppdateraDatum();
fetchWeather();
fetchElpris();

setInterval(uppdateraDatum, 60000);
setInterval(fetchWeather, 300000); // var 5:e minut
setInterval(fetchElpris, 900000);   // var 15:e minut
</script>

</body>
</html>

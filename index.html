<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>V√§der Dashboard</title>
</head>

<body style="font-family: Arial; background:#111; color:white; text-align:center; padding-top:40px">

<div id="temp-now" style="font-size:28px"></div>
<div id="wind"></div>
<div id="humidity"></div>
<div id="pressure"></div>
<div id="precipitation"></div>
<div id="weather-updated" style="margin-top:20px; font-size:12px; opacity:0.7"></div>

<script>

const lat = 57.166;   // Bor
const lon = 14.033;

async function updateWeatherNow() {

  try {

    const url = `https://opendata-download-metfcst.smhi.se/api/category/pmp3g/version/2/geotype/point/lon/${lon}/lat/${lat}/data.json`;
    const res = await fetch(url);
    const data = await res.json();

    const now = new Date();

    const nearest = data.timeSeries.reduce((a,b) =>
      Math.abs(new Date(b.validTime)-now) <
      Math.abs(new Date(a.validTime)-now) ? b : a
    );

    const params = nearest.parameters;

    const temp = params.find(p => p.name === 't')?.values[0];
    const wind = params.find(p => p.name === 'ws')?.values[0];
    const humidity = params.find(p => p.name === 'r')?.values[0];
    const pressure = params.find(p => p.name === 'msl')?.values[0];
    const precip = params.find(p => p.name === 'pmean')?.values[0];
    const precipType = params.find(p => p.name === 'pcat')?.values[0];
    const cloud = params.find(p => p.name === 'tcc_mean')?.values[0];

    // ---- K√ÑNNS SOM ----
    let feelsLike = temp;

    if (temp !== undefined && wind !== undefined) {
      if (temp <= 10 && wind > 1.3) {
        const windKmH = wind * 3.6;
        feelsLike =
          13.12 +
          0.6215 * temp -
          11.37 * Math.pow(windKmH, 0.16) +
          0.3965 * temp * Math.pow(windKmH, 0.16);
      }
    }

    // ---- IKONLOGIK ----
    let icon = "‚òÄÔ∏è";

    if (precip !== undefined && precipType !== undefined && precip > 0.1) {

      if (precipType === 3) {
        icon = "‚ùÑÔ∏è";   // sn√∂
      }
      else if (precipType === 2) {
        icon = "üåßÔ∏è";   // regn
      }
      else {
        icon = "üå¶Ô∏è";   // blandat
      }

    } else if (cloud !== undefined) {

      if (cloud > 80) {
        icon = "‚òÅÔ∏è";   // mulet
      }
      else if (cloud > 40) {
        icon = "üå•Ô∏è";   // v√§xlande molnighet
      }
      else {
        icon = "‚òÄÔ∏è";   // klart
      }

    }

    // ---- UTSKRIFT ----

    if (temp !== undefined && feelsLike !== undefined) {
      document.getElementById('temp-now').innerHTML =
        `<div style="font-size:42px">${icon}</div>
         ${temp.toFixed(1)} ¬∞C (${feelsLike.toFixed(1)} ¬∞C)`;
    }

    document.getElementById('wind').innerText =
      wind !== undefined ? `Vind: ${wind.toFixed(1)} m/s` : 'Vind: --';

    document.getElementById('humidity').innerText =
      humidity !== undefined ? `Luftfuktighet: ${humidity.toFixed(0)} %` : 'Luftfuktighet: --';

    document.getElementById('pressure').innerText =
      pressure !== undefined ? `Tryck: ${pressure.toFixed(0)} hPa` : 'Tryck: --';

    document.getElementById('precipitation').innerText =
      precip !== undefined && precip > 0
        ? `Nederb√∂rd kommande timme: ${precip.toFixed(1)} mm`
        : `Nederb√∂rd kommande timme: 0 mm`;

    document.getElementById('weather-updated').innerText =
      'Senast uppdaterad: ' + now.toLocaleTimeString('sv-SE');

  }

  catch(err) {
    console.error("SMHI error:", err);
  }

}

updateWeatherNow();
setInterval(updateWeatherNow, 600000);

</script>

</body>
</html>

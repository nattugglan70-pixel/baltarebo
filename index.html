<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Väder Hagshult</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f0f0; color: #222; padding: 20px; }
  .weather-box { background: #fff; border-radius: 10px; padding: 20px; max-width: 400px; }
  .section { margin-bottom: 15px; }
  .label { font-weight: bold; }
  .yellow { color: goldenrod; }
  .icon { font-size: 24px; margin-left: 5px; }
</style>
</head>
<body>
<div class="weather-box">
  <div class="section" id="header">
    <span id="date"></span> | <span id="update-time"></span>
  </div>

  <div class="section" id="temperature">
    Temperatur: <span id="temp-now"></span> (<span id="temp-feels"></span>)<br>
    <span class="yellow">Gårdagens temp samma tid: <span id="temp-yesterday"></span></span>
  </div>

  <div class="section" id="conditions">
    Vind: <span id="wind"></span> m/s<br>
    Luftfuktighet: <span id="humidity"></span> %<br>
    Tryck: <span id="pressure"></span> hPa<br>
    Nederbörd senaste 24h: <span id="precip"></span> mm <span id="precip-icon" class="icon"></span>
  </div>

  <div class="section" id="minmax-today">
    <span class="label">Dagens min/max:</span><br>
    Min: <span id="min-today"></span> kl <span id="min-today-time"></span><br>
    Max: <span id="max-today"></span> kl <span id="max-today-time"></span>
  </div>

  <div class="section" id="minmax-yesterday">
    <span class="label">Gårdagens min/max:</span><br>
    Min: <span id="min-yesterday"></span> kl <span id="min-yesterday-time"></span><br>
    Max: <span id="max-yesterday"></span> kl <span id="max-yesterday-time"></span>
  </div>
</div>

<script>
// SMHI Hagshult Station ID
const stationId = 74180;

// Parametrar: temperatur=1, vind=17, luftfuktighet=10, tryck=9, nederbörd=8
const parameters = { temp: 1, wind: 17, humidity: 10, pressure: 9, precip: 8 };

// Konvertera UTC → svensk tid
function toLocalTime(utcString) {
  const date = new Date(utcString + "Z");
  return new Date(date.getTime() + 3600*1000); // +1 timme CET/1h offset
}

// Formatera datum/tid
function formatDate(date) {
  const day = date.getDate().toString().padStart(2,'0');
  const month = (date.getMonth()+1).toString().padStart(2,'0');
  const year = date.getFullYear();
  return `${day}/${month}/${year}`;
}
function formatTime(date) {
  return date.getHours().toString().padStart(2,'0') + ':' + date.getMinutes().toString().padStart(2,'0');
}

// Hämta observationer från SMHI
async function fetchObs(param) {
  const url = `https://opendata-download-metobs.smhi.se/api/version/1.0/parameter/${param}/station/${stationId}/period/latest-day/data.json`;
  const resp = await fetch(url);
  const data = await resp.json();
  return data.value;
}

// Beräkna min/max med tid
function calcMinMax(values, timestamps) {
  let min = Infinity, max = -Infinity;
  let minTime = '', maxTime = '';
  for (let i=0; i<values.length; i++) {
    if (values[i] < min) { min = values[i]; minTime = timestamps[i]; }
    if (values[i] > max) { max = values[i]; maxTime = timestamps[i]; }
  }
  return { min, minTime, max, maxTime };
}

// Bestäm ikon baserat på nederbörd (☂️ regn, ❄️ snö, ☀️ sol, ☁️ moln)
function getPrecipIcon(mm) {
  if (mm > 0 && mm <= 0.5) return '☂️';
  if (mm > 0.5) return '❄️';
  return '☀️';
}

// Huvudfunktion
async function updateWeather() {
  const now = new Date();
  document.getElementById('date').textContent = formatDate(now);

  // Hämta observationer
  const tempData = await fetchObs(parameters.temp);
  const windData = await fetchObs(parameters.wind);
  const humidityData = await fetchObs(parameters.humidity);
  const pressureData = await fetchObs(parameters.pressure);
  const precipData = await fetchObs(parameters.precip);

  // Senaste värden
  const tempNow = tempData[tempData.length-1].value.toFixed(1);
  const tempFeels = (tempNow - windData[windData.length-1].value * 0.7).toFixed(1); // enkel wind chill approx
  const windNow = windData[windData.length-1].value.toFixed(1);
  const humidityNow = humidityData[humidityData.length-1].value.toFixed(0);
  const pressureNow = pressureData[pressureData.length-1].value.toFixed(0);

  document.getElementById('temp-now').textContent = tempNow + ' °C';
  document.getElementById('temp-feels').textContent = tempFeels + ' °C';
  document.getElementById('wind').textContent = windNow;
  document.getElementById('humidity').textContent = humidityNow;
  document.getElementById('pressure').textContent = pressureNow;

  // Nederbörd senaste 24h
  let precipSum = 0;
  for (let i=0;i<precipData.length;i++) precipSum += precipData[i].value;
  document.getElementById('precip').textContent = precipSum.toFixed(1);
  document.getElementById('precip-icon').textContent = getPrecipIcon(precipSum);

  // Min/Max idag
  const timestamps = tempData.map(x => toLocalTime(x.date));
  const values = tempData.map(x => x.value);
  const today = timestamps.filter(d => d.getDate() === now.getDate());
  const todayVals = values.slice(-today.length);
  const todayTimes = timestamps.slice(-today.length);
  const minMaxToday = calcMinMax(todayVals, todayTimes);
  document.getElementById('min-today').textContent = minMaxToday.min.toFixed(1) + ' °C';
  document.getElementById('min-today-time').textContent = formatTime(minMaxToday.minTime);
  document.getElementById('max-today').textContent = minMaxToday.max.toFixed(1) + ' °C';
  document.getElementById('max-today-time').textContent = formatTime(minMaxToday.maxTime);

  // Gårdagens min/max
  const yesterday = timestamps.filter(d => d.getDate() === now.getDate()-1);
  if (yesterday.length>0){
    const yesterdayVals = values.slice(-yesterday.length);
    const yesterdayTimes = timestamps.slice(-yesterday.length);
    const minMaxYesterday = calcMinMax(yesterdayVals, yesterdayTimes);
    document.getElementById('min-yesterday').textContent = minMaxYesterday.min.toFixed(1) + ' °C';
    document.getElementById('min-yesterday-time').textContent = formatTime(minMaxYesterday.minTime);
    document.getElementById('max-yesterday').textContent = minMaxYesterday.max.toFixed(1) + ' °C';
    document.getElementById('max-yesterday-time').textContent = formatTime(minMaxYesterday.maxTime);
    document.getElementById('temp-yesterday').textContent = values[timestamps.findIndex(t => t.getHours() === now.getHours())].toFixed(1) + ' °C';
  } else {
    document.getElementById('min-yesterday').textContent = 'Uppdateras 06:00';
    document.getElementById('min-yesterday-time').textContent = '--';
    document.getElementById('max-yesterday').textContent = 'Uppdateras 06:00';
    document.getElementById('max-yesterday-time').textContent = '--';
    document.getElementById('temp-yesterday').textContent = '--';
  }

  document.getElementById('update-time').textContent = 'Senast uppdaterad: ' + formatTime(now);
}

updateWeather();
</script>
</body>
</html>

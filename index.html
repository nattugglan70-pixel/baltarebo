<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Minimal Dashboard</title>
<style>
  body {
    background: black;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .date { font-size: 18px; margin-bottom: 20px; }
  .temp { font-size: 70px; font-weight: bold; }
  .feels { font-size: 22px; margin-top: -6px; opacity: 0.8; }
  .weather-updated { font-size: 16px; margin-top: 5px; opacity: 0.7; }
  .elprice { font-size: 20px; margin-top: 40px; }
  .el-updated { font-size: 16px; margin-top: 5px; opacity: 0.7; }
</style>
</head>
<body>

<div class="date" id="date"></div>

<div class="temp" id="temp">--°C</div>
<div class="feels" id="feels">Känns som --°C</div>
<div class="weather-updated" id="updated">Senast väderuppdatering: --:--</div>

<div class="elprice" id="elprice">Elpris: -- kr/kWh</div>
<div class="el-updated" id="el-updated">Senast elprisuppdatering: --:--</div>

<script>
// ===== Datum + Veckonummer
function showDate() {
  const now = new Date();
  const dayNames = ["Söndag","Måndag","Tisdag","Onsdag","Torsdag","Fredag","Lördag"];
  const day = dayNames[now.getDay()];
  const month = now.toLocaleString('sv-SE', {month:'long'});
  const week = Math.ceil(((now - new Date(now.getFullYear(),0,1)) / (24*60*60*1000) + new Date(now.getFullYear(),0,1).getDay()+1)/7);
  document.getElementById("date").textContent = `${day} ${now.getDate()} ${month} ${now.getFullYear()} | Vecka ${week}`;
}

// ===== Feels like (wind chill)
function feelsLike(tempC, windMS) {
  return Math.round(13.12 + 0.6215*tempC - 11.37*Math.pow(windMS,0.16) + 0.3965*tempC*Math.pow(windMS,0.16));
}

// ===== Väder: temperatur + vind
async function fetchWeather() {
  const latitude = 57.114025;
  const longitude = 14.168177;

  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&windspeed_unit=ms`;
    const res = await fetch(url);
    const data = await res.json();
    const cw = data.current_weather;

    const t = cw.temperature;
    const w = cw.windspeed;

    document.getElementById("temp").textContent = `${t.toFixed(1)}°C`;
    document.getElementById("feels").textContent = `Känns som ${feelsLike(t,w)}°C`;

    const now = new Date();
    const hh = now.getHours().toString().padStart(2,"0");
    const mm = now.getMinutes().toString().padStart(2,"0");
    document.getElementById("updated").textContent = `Senast väderuppdatering: ${hh}:${mm}`;

  } catch(e) {
    document.getElementById("temp").textContent = "--°C";
    document.getElementById("feels").textContent = "Känns som --°C";
    document.getElementById("updated").textContent = `Senast väderuppdatering: --:--`;
  }
}

// ===== Elpris: uppdatera endast när timmen byts
let lastHour = -1;
async function fetchElpris() {
  const now = new Date();
  const currentHour = now.getHours();

  if(currentHour === lastHour) return; // ingen ny timme, hoppa över
  lastHour = currentHour;

  try {
    const year  = now.getFullYear();
    const month = (now.getMonth()+1).toString().padStart(2,"0");
    const day   = now.getDate().toString().padStart(2,"0");

    const zone = "SE3"; // Södra Sverige
    const url = `https://www.elprisetjustnu.se/api/v1/prices/${year}/${month}-${day}_${zone}.json`;

    const res = await fetch(url);
    const data = await res.json();

    const price = data[currentHour]?.price_sek ?? null;
    if(price !== null) {
      document.getElementById("elprice").textContent = `Elpris: ${price.toFixed(2)} kr/kWh`;
      document.getElementById("el-updated").textContent = `Senast elprisuppdatering: ${currentHour}:00`;
    } else {
      document.getElementById("elprice").textContent = `Elpris: -`;
      document.getElementById("el-updated").textContent = `Senast elprisuppdatering: --:--`;
    }

  } catch(e) {
    document.getElementById("elprice").textContent = `Elpris: -`;
    document.getElementById("el-updated").textContent = `Senast elprisuppdatering: --:--`;
  }
}

// Init
showDate();
fetchWeather();
fetchElpris();

// Vädret var 5:e minut
setInterval(fetchWeather, 5*60*1000);

// Elpriset kontrolleras varje minut, men hämtas bara vid timbyte
setInterval(fetchElpris, 60*1000);
</script>
</body>
</html>

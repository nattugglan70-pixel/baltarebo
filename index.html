<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Dashboard – Väder & Elpris</title>
<style>
  body {
    background: black;
    color: white;
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 0;
    padding: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .section { margin-bottom: 20px; }
  .temp { font-size: 70px; font-weight: bold; }
  .feels { font-size: 22px; opacity: 0.8; margin-top: -5px; }
  .small { font-size: 18px; }
  .el-block { margin-top: 30px; }
  .el-item { font-size: 20px; margin: 6px 0; }
  .el-meta { font-size: 16px; opacity: 0.7; }
</style>
</head>
<body>

<div class="section" id="weather-section">
  <div id="date" class="small"></div>
  <div class="temp" id="temp">--°C</div>
  <div class="feels" id="feels">Känns som --°C</div>
  <div id="weather-updated" class="small">Senast väderuppdatering: --:--</div>
</div>

<div class="section el-block">
  <div id="current-el" class="el-item">Elpris klockan --:00: -- kr/kWh</div>
  <div id="next-el" class="el-item">Nästa pris klockan --:00: --</div>

  <div id="el-stats" class="el-item">
    Lägsta: -- &nbsp;|&nbsp;
    Högsta: -- &nbsp;|&nbsp;
    Medel: --
  </div>

  <div id="el-updated" class="el-meta">Senast elprisuppdatering: --:--</div>
</div>

<script>

// ————— Datum + Veckonummer —————
function showDate() {
  const now = new Date();
  const dayNames = ["Söndag","Måndag","Tisdag","Onsdag","Torsdag","Fredag","Lördag"];
  const month = now.toLocaleString('sv-SE', {month:'long'});
  const weekNum = Math.ceil(((now - new Date(now.getFullYear(),0,1)) / (24*60*60*1000) +
     new Date(now.getFullYear(),0,1).getDay()+1)/7);
  document.getElementById("date").textContent =
    `${dayNames[now.getDay()]} ${now.getDate()} ${month} ${now.getFullYear()} | Vecka ${weekNum}`;
}

// ————— Feels like —————
function feelsLike(tempC, windMS) {
  return Math.round(13.12 + 0.6215*tempC - 11.37*Math.pow(windMS,0.16) + 0.3965*tempC*Math.pow(windMS,0.16));
}

// ————— Väder —————
async function fetchWeather() {
  const lat = 57.114025, lon = 14.168177;
  try {
    const res = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&windspeed_unit=ms`
    );
    const json = await res.json();
    const cw = json.current_weather;

    document.getElementById("temp").textContent = `${cw.temperature.toFixed(1)}°C`;
    document.getElementById("feels").textContent =
      `Känns som ${feelsLike(cw.temperature, cw.windspeed)}°C`;

    const now = new Date();
    document.getElementById("weather-updated").textContent =
      `Senast väderuppdatering: ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

  } catch(e) {
    document.getElementById("temp").textContent = "--°C";
    document.getElementById("feels").textContent = "Känns som --°C";
  }
}

// ————— Elpris (statistik) —————
async function fetchElData() {
  const now = new Date();
  const year  = now.getFullYear();
  const month = String(now.getMonth()+1).padStart(2,'0');
  const day   = String(now.getDate()).padStart(2,'0');

  try {
    const url = `https://www.elprisetjustnu.se/api/v1/prices/${year}/${month}-${day}_SE4.json`;
    const res = await fetch(url);
    const data = await res.json();

    let prices = [], hours = Object.keys(data);
    hours.forEach(h => {
      const p = data[h]?.price_sek;
      if(typeof p === "number") prices.push({hour: Number(h), price: p});
    });

    if(prices.length === 0) throw "ingen prisdata än";

    // — Aktuellt pris (senaste före eller = nu)
    const currentHour = now.getHours();
    let current = prices.filter(x => x.hour <= currentHour).pop() || null;
    let next    = prices.filter(x => x.hour > currentHour).shift() || null;

    // — Stats
    const allVals = prices.map(x => x.price);
    const lowest = Math.min(...allVals);
    const highest= Math.max(...allVals);
    const avg    = (allVals.reduce((s,v) => s+v, 0) / allVals.length);

    document.getElementById("current-el").textContent =
      `Elpris klockan ${current ? current.hour : "--"}:00: ${current ? current.price.toFixed(2) : "--"} kr/kWh`;

    document.getElementById("next-el").textContent =
      `Nästa pris klockan ${next ? next.hour : "--"}:00: ${next ? next.price.toFixed(2) : "-"}`;

    document.getElementById("el-stats").textContent =
      `Lägsta: ${lowest.toFixed(2)} | Högsta: ${highest.toFixed(2)} | Medel: ${avg.toFixed(2)}`;

    document.getElementById("el-updated").textContent =
      `Senast elprisuppdatering: ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;

  } catch(e) {
    document.getElementById("current-el").textContent = "Elpris klockan --:00: --";
    document.getElementById("next-el").textContent    = "Nästa pris klockan --:00: -";
    document.getElementById("el-stats").textContent  = "Lägsta: -- | Högsta: -- | Medel: --";
    document.getElementById("el-updated").textContent= "Senast elprisuppdatering: --:--";
  }
}

// ————— Init —————
showDate();
fetchWeather();
fetchElData();

// ————— Intervaller —————
setInterval(fetchWeather, 5*60*1000); // väder var 5 min
setInterval(fetchElData, 60*1000);    // elpris var min

</script>
</body>
</html>
